# -*- coding: utf-8 -*-
"""Untitled9.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/14ef0fU0K3nbmX8nx88-3nXu8PyjwN4_s
"""

import streamlit as st
import zipfile
import io
import random
import requests

# ãƒ’ãƒ³ãƒˆç”Ÿæˆé–¢æ•°
def generate_hint(answer: str) -> str:
    hint = ""
    for char in answer:
        if char.isalpha() or ('ã' <= char <= 'ã‚“') or ('ã‚¡' <= char <= 'ãƒ³') or ('ä¸€' <= char <= 'é¾¥'):
            hint += "ã€‡"
        elif char == " ":
            hint += "â–¡"
        else:
            hint += char
    return hint

# ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ç­”ãˆã‚’æŠ½å‡º
def extract_answer(filename: str) -> str:
    name = filename.rsplit("/", 1)[-1]
    name = name.rsplit(".", 1)[0]
    parts = name.split("_", 1)
    return parts[1] if len(parts) == 2 else parts[0]

# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
if "questions" not in st.session_state:
    st.session_state.questions = []
if "current_q" not in st.session_state:
    st.session_state.current_q = 0
if "score" not in st.session_state:
    st.session_state.score = 0
if "zip_data" not in st.session_state:
    st.session_state.zip_data = None

# ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜
st.title("ğŸ® ã‚¢ãƒ‹ã‚½ãƒ³ã‚¯ã‚¤ã‚ºï¼ˆDropboxãƒªãƒ³ã‚¯å¼ï¼‰")
st.markdown("""
#### ğŸ“ èª¬æ˜
- æ›²ã®ä¸€éƒ¨ãŒæµã‚Œã¾ã™ã€‚
- **ã²ã‚‰ãŒãªã€ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®å°æ–‡å­—**ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
- **ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆâ–¡ï¼‰ã€ãƒ‰ãƒƒãƒˆã€è¨˜å·**ã¯ãƒ’ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
- **200å•ä»¥ä¸Šã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã§100å•**å‡ºé¡Œã•ã‚Œã¾ã™ã€‚é †æ¬¡è¿½åŠ äºˆå®šã€‚
- å•é¡Œã¯**ä¸€åº¦ã—ã‹æµã‚Œã¾ã›ã‚“**ã€‚
- å‡ºé¡ŒåŸºæº–ã¯ã€Œ**ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’è¦‹ã¦ã„ã‚Œã°å›ç­”ã§ãã‚‹**ã€ã§ã™ã€‚
- éŸ³é‡ãŒä¸€å®šã§ãªã„ã®ã§ã€**éŸ³é‡ã®ä¸Šã’ã™ãã«ã¯ã”æ³¨æ„ãã ã•ã„**ã€‚
- https://www.dropbox.com/scl/fi/dd0qczry3kby7xx5efu8v/mp3.zip?rlkey=r5z6f87casa0kk5e889z5h9of&st=fpg6f1a5&raw=1
""")

# Dropboxãƒªãƒ³ã‚¯å…¥åŠ›æ¬„
dropbox_url = st.text_input("ğŸ“ Dropboxã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ï¼ˆæœ«å°¾ã¯ ?raw=1 ã«ã—ã¦ãã ã•ã„ï¼‰")

if dropbox_url and not st.session_state.questions:
    with st.spinner("ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."):
        response = requests.get(dropbox_url)
        st.session_state.zip_data = io.BytesIO(response.content)

        with zipfile.ZipFile(st.session_state.zip_data) as z:
            mp3_files = sorted([f for f in z.namelist() if f.endswith(".mp3")])
            random.shuffle(mp3_files)
            st.session_state.questions = mp3_files[:100]

if st.session_state.questions:
    current_idx = st.session_state.current_q
    mp3_file = st.session_state.questions[current_idx]

    with zipfile.ZipFile(st.session_state.zip_data) as z:
        mp3_data = z.read(mp3_file)
        correct_answer = extract_answer(mp3_file).strip()

    st.subheader(f"ğŸµ ç¬¬ {current_idx + 1} å•")
    st.audio(mp3_data, format="audio/mp3")
    st.write("ğŸ” ãƒ’ãƒ³ãƒˆï¼š" + generate_hint(correct_answer))

    user_input = st.text_input("ç­”ãˆã‚’å…¥åŠ›ï¼ˆã²ã‚‰ãŒãªãƒ»è‹±å°æ–‡å­—ï¼‰", key=f"answer_{current_idx}")

    if st.button("å›ç­”ã™ã‚‹"):
        if user_input.strip() == correct_answer:
            st.success("ğŸ‰ æ­£è§£ï¼")
            st.session_state.score += 1
        else:
            st.error(f"âŒ ä¸æ­£è§£â€¦ æ­£è§£ã¯ã€Œ{correct_answer}ã€ã§ã—ãŸ")

        st.session_state.current_q += 1

        if st.session_state.current_q >= len(st.session_state.questions):
            st.markdown("---")
            st.header("ğŸ ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼")
            st.write(f"ã‚ãªãŸã®ã‚¹ã‚³ã‚¢ï¼š**{st.session_state.score} / {len(st.session_state.questions)}**")
            st.balloons()
            # ãƒªã‚»ãƒƒãƒˆ
            st.session_state.questions = []
            st.session_state.current_q = 0
            st.session_state.score = 0
            st.session_state.zip_data = None